<!DOCTYPE html>
<html>
  <head>
    <script src="jquery-3.6.0.js" type="text/javascript"></script>
    <script type="text/javascript">
      /*
      Решение будет работать с отключенным CORS в браузере или через прокси,
      который добавит нужные заголовки.
      Сервер API не возвращает заголовки Access-Control-Allow-* 
      необходимые для работы с разными источниками такие, как
      Access-Control-Allow-Headers: authorization
      Access-Control-Allow-Methods: PATCH, GET, POST
      Access-Control-Allow-Origin: *

      В качестве прокси может быть использован плагин для Хрома 
      например, "Allow CORS: Access-Control-Allow-Origin" 
      https://chrome.google.com/webstore/detail/allow-cors-access-control/lhobafahddgcelffkeicbaginigeejlf/
      или настроенный прокси сервер CORS Anywhere на heroku.com
      https://getthekt.com/setup-your-own-cors-proxy-on-heroku/
      https://www.youtube.com/watch?v=zoOx1b9iBRk (CORS Anywhere Installation on Heroku)
      */

      // JWT токен для авторизации в amocrm API
      // данный токен действителен до 2 февраля, 17:00 МСК
      const access_token = 'eyJ0eXAiOiJKV1QiLCJhbGciOiJSUzI1NiIsImp0aSI6IjViNGJkNGZlMGI2M2FkYjNiNTQ1NDhkMTZhMTU2NTkyZDAyNWY0MDJhYjgwNGFlNWZiMWE5ZDMwMzU5YzZkMWM1ZTkwNzg2NzQ1MGJiZTE4In0.eyJhdWQiOiIzNGUwZGU4Zi0wODE0LTRlNzUtODgzZC00MjkzODg5MDljMTkiLCJqdGkiOiI1YjRiZDRmZTBiNjNhZGIzYjU0NTQ4ZDE2YTE1NjU5MmQwMjVmNDAyYWI4MDRhZTVmYjFhOWQzMDM1OWM2ZDFjNWU5MDc4Njc0NTBiYmUxOCIsImlhdCI6MTY0MzcyNDg3NCwibmJmIjoxNjQzNzI0ODc0LCJleHAiOjE2NDM4MTEyNzQsInN1YiI6Ijc4NzA4NjciLCJhY2NvdW50X2lkIjoyOTk3NDU3Mywic2NvcGVzIjpbInB1c2hfbm90aWZpY2F0aW9ucyIsImNybSIsIm5vdGlmaWNhdGlvbnMiXX0.hP62CilTN4RrCW8_LkxDkfqPu9xnAC8KZRzg8FFVOoN18OG1ZHGnKNgwOLths3RLAQODXUsrcTiycNuuXEgaQYJUDFTtN-cyoOc9eML0e-G_pFRcvM6l4J5LBqXqsH7agU7bnu15QtBHK8LRBVGYEKIjgrKnLcVN4-DMHiu4UXrXTNI0JldlbSIoYrL755v0c7tB8A4CqJBJcfTDT1g52FhE5MjadRolmpRslFu2TjFlHtu3KAewXWaV6S4QtBl-qT-65_Mrv32Z8c5G9xgqlxPqPdmlIa8dUR10aSjwSbbLaNJxlP0zTR7sajxWDAVrGpXy9mnguvPSX5qlYno5WQ';

      // название задачи
      const taskName = 'Контакт без сделок';

      // API хост
      const hostAddr = 'https://farkhad.amocrm.ru';

      // адрес API для пакетного создания задач
      const tasksCreateUrl = '/api/v4/tasks';

      // кол-во возвращаемых записей контактов
      const limit = 25;
      
      // номер страницы с контактами
      let page = 1;
      
      // адрес API для работы с контактами
      // необходимо явно указать по какому полю сортировать (например, ?order[id]=asc)
      // чтобы сервер возвращал всегда уникальный набор контактов для указанного page & limit
      let getContactsListQueryUrl = '/api/v4/contacts?order[id]=asc';
      
      // Адрес API задач для поиска задач, связанных с контактами 
      // - с привязанным контактом (entity_type=contacts&entity_id[]=xxx)
      // - типом задачи: звонок (1)
      // - статусом задачи: к выполнению (незавершенные)
      // Если такие задачи не найдены, будет возвращена пустая строка String(0)
      // Если будут найдены связанные задачи с текстом "Контакт без сделок", то
      // создавать новую задачу "Контакт без сделок" для данного контакта не надо
      // Пример ответа: https://www.amocrm.ru/developers/content/crm_platform/tasks-api
      let tasksContactsQueryUrl = '/api/v4/tasks?filter[task_type]=1&filter[is_completed]=0&filter[entity_type]=contacts';

      function getContacts() {
        $.ajax({
            crossDomain: true,
            url: hostAddr + getContactsListQueryUrl,
            method: 'GET',
            data: {
                limit: limit,
                with: 'leads',
                page: page
            },
            dataType: 'json',
            headers: {
              Authorization: 'Bearer ' + access_token
            }
        }).done(function(data) {
            if (!!data) {
                if (typeof data._embedded.contacts != 'undefined') {
                  // Обработка полученного массива контактов
                  // - поиск связанных задач
                  // - создание задач для контактов без сделок
                  processContacts(data._embedded.contacts);

                  // Продолжаем искать контакты на другой странице
                  // Переменная page будет увеличена на единицу к этому моменту 
                  getContacts();
                } else {
                  console.log('Отсутствует массив контактов', data);
                  return false;
                }
            } else {
                console.log('Контактов нет');
                return false;
            }
        }).fail(function(data) {
            console.log('Что-то пошло не так c получением контактов', data);
            return false;
        });

        page++;
      }

      // Обработка массива контактов
      function processContacts(contacts) {
        // массив ID контаков без сделок
        let contactsNoLeads = getContactsWithNoLeads(contacts);

        // проверяем нашлись ли контакты без сделок
        if (contactsNoLeads.length > 0) {
          // проверяем, есть ли у найденных контактов связанные задачи
          // не указываем limit, page, т.к. оперируем уже ограниченным набором ID контактов
          $.ajax({
            crossDomain: true,
            url: hostAddr + tasksContactsQueryUrl,
            method: 'GET',
            data: {
              // jQuery автоматически переведет массив ID 
              // в правильную форму query_string
              'filter[entity_id]': contactsNoLeads
            },
            dataType: 'json',
            headers: {
              Authorization: 'Bearer ' + access_token
            }
          }).done(function(data) {
            if (!!data && typeof data._embedded.tasks != 'undefined') {
              // нашли связанные с массивом контактов задачи
              data._embedded.tasks.forEach(task => {
                // Если задача с заданным названием taskName существует,
                // то новую задачу для этого контакта не создаем
                if (task.text === taskName) {
                  // Удаляем ID контакта из массива контактов, 
                  // чтобы не создавать задачу для него
                  let contactIdx = contactsNoLeads.indexOf(task.entity_id);
                  if (contactIdx > -1) {
                    // удаляем найденный элемент из массива контактов
                    contactsNoLeads.splice(contactIdx, 1);
                  }
                }
              });
            }

            // создаем задачи для отобранных контактов
            // массив contactsNoLeads ранее мог быть обновлен,
            // поэтому снова проверяем есть ли в нем элементы
            if (contactsNoLeads.length > 0) {
              createTasksWithContacts(contactsNoLeads);
            }
          }).fail(function(data) {
            console.log("Что-то пошло не так с поиском задач", data);
            return false;
          });
        }
      }

      // Получить массив ID контактов без сделок
      function getContactsWithNoLeads(contacts) {
        // локальный массив контаков без сделок
        let contactsNoLeads = [];

        contacts.forEach(contact => {
          // Ищем контакт без сделки (= нет привязанной сущности leads)
          if (contact._embedded.leads.length === 0) {
            // Контакт без сделок
            // Сохраняем контакт в массиве контактов без сделки
            contactsNoLeads.push(contact.id);
          }
        });

        return contactsNoLeads;
      }

      // Получить массив задач для создания
      function getTasksToCreate(contactsNoLeads) {
        // API позволяет создать задачи пакетно,
        // подготовим массив новых задач
        let tasksToCreate = [];

        // дата завершения задачи в формате unix timestamp
        // срок завершения = через 7 суток
        let completeTillUnixTimestamp = Math.floor(Date.now() / 1000 + 7 * 86400);
        
        // заполним массив новых задач
        contactsNoLeads.forEach(contactID => {
          tasksToCreate.push(
            JSON.stringify({
              entity_id: contactID,
              entity_type: 'contacts',
              text: taskName,
              complete_till: completeTillUnixTimestamp,
              task_type_id: 1
            })
          );
        });
        
        return tasksToCreate;
      }

      // пакетное создание задач, связанных с контактами без сделок
      function createTasksWithContacts(contactsNoLeads) {
        // получить массив задач для создания
        let tasksToCreate = getTasksToCreate(contactsNoLeads);

        if (tasksToCreate.length > 0) {
          // создаем задачи для контактов без сделок
          $.ajax({
            crossDomain: true,
            url: hostAddr + tasksCreateUrl,
            method: 'POST',
            data: '[' + tasksToCreate.join(",") + ']',
            dataType: 'json',
            headers: {
              Authorization: 'Bearer ' + access_token
            }
          }).done(function(data) {
            console.log('Новые задачи были созданы', data);
            logIt(JSON.stringify(data._embedded.tasks));
          }).fail(function(data) {
            console.log('Что-то пошло не так с попыткой создать новые задачи', data);
            return false;
          });
        }
      }

      function logIt(msg) {
        $('#log').append(msg);
      }

      $(document).ready(function(){
        $('#create-tasks').click(function() {
          $(this).attr('disabled', true);
          getContacts();
        });
      });
    </script>
  </head>
  <body>
    <button type="button" id="create-tasks">Создать задачи для контактов без сделок</button>
    <div id="log"></div>
  </body>
</html>
